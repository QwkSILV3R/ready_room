<FULL UPDATED CODE FROM CANVAS>